<script src="{$web_static}/js/uploadImg.js"></script>
<form class="form-horizontal js-ajax-form clearfix" action='{:U('add')}'>
<div class="panel panel-default">
    <div class="panel" style="border-bottom: 1px solid #e7eaec">
        <p style="margin:5px;font-size: 14px;color: #1ab394;font-weight:bold">基本信息</p>
    </div>
    
    <div class="form-group" style="margin-top: 20px;">
        <label for="brand_id" class="col-sm-2 control-label">商品品牌</label>
        <div class="col-sm-4">
            <select   class="form-control"  name="brand_id" id="brand_id" onchange="get_model(this)">
                {volist name="brands" id="v"}
                    <option value="{$v.brand_id}" {if condition="input('brand_id') ==$v.brand_id"}selected{/if}>{$v.brand_name}</option>
                {/volist}
            </select>
        </div>
    </div>
    <div class="form-group" style="margin-top: 20px;">
        <label for="sort" class="col-sm-2 control-label">型号</label>
        <div class="col-sm-8" id="model_list">
            {if condition="count($model) neq 0"}
                {volist name="$model" id="vo"}
                <label class="i-lab">
                    <input type="radio" name="model_id" value="{$vo.model_id}" class="mgr mgr-primary  mgr-lg" ><span>{$vo.name}</span>
                </label>
                {/volist}
            {else/}
                <label class="i-lab">
                    该品牌未添加型号
                </label>
            {/if}
        </div>
    </div>
    <div class="form-group" style="margin-top: 20px;">
        <label for="goods_name" class="col-sm-2 control-label">商品名称</label>
        <div class="col-sm-4">
            <input type="text" name="goods_name" class="form-control" id="goods_name" placeholder="商品名称">
        </div>
    </div>
    <div class="form-group" style="margin-top: 20px;">
        <label for="report_id" class="col-sm-2 control-label">质检报告</label>
        <div class="col-sm-4">
            <select   class="form-control"  name="report_id" id="report_id" >
                
                {volist name="check_info" id="v"}
                    <option value="{$v.id}">{$v.check_name}</option>
                {/volist}
            </select>
        </div>
    </div>
    <!--  <div class="form-group" style="margin-top: 20px;">
        <label for="market_price" class="col-sm-2 control-label">商品市场价格</label>
        <div class="col-sm-4">
            <input type="text" name="market_price" class="form-control" id="market_price" placeholder="商品价格">
        </div>
    </div>
    <div class="form-group" style="margin-top: 20px;">
        <label for="shop_price" class="col-sm-2 control-label">商品店铺价格</label>
        <div class="col-sm-4">
            <input type="text" name="shop_price" class="form-control" id="shop_price" placeholder="商品价格">
        </div>
    </div>
    <div class="form-group" style="margin-top: 20px;">
        <label for="goods_unit" class="col-sm-2 control-label">商品单位</label>
        <div class="col-sm-4">
            <input type="text" name="goods_unit" class="form-control" id="goods_unit" placeholder="商品单位">
        </div>
    </div> -->

    <div class="form-group" style="border-bottom: 1px solid #e7eaec;margin:5px; ">
        <label for="sort" class="col-sm-2 control-label ">好评标签</label>
        <div class="col-sm-10">
            <label class="i-lab">
                <input type="checkbox" name="evaluate[0]" value="很靠谱" class="mgr mgr-primary  mgr-lg attr_value" checked><span>很靠谱</span>
            </label>
            <label class="i-lab">
                <input type="checkbox" name="evaluate[1]" value="物流快" class="mgr mgr-primary  mgr-lg attr_value"><span>物流快</span>
            </label>
            <label class="i-lab">
                <input type="checkbox" name="evaluate[2]" value="物美价廉" class="mgr mgr-primary  mgr-lg attr_value"><span>物美价廉</span>
            </label>
            <label class="i-lab">
                <input type="checkbox" name="evaluate[3]" value="服务好" class="mgr mgr-primary  mgr-lg attr_value"><span>服务好</span>
            </label>
            <label class="i-lab">
                <input type="checkbox" name="evaluate[4]" value="成色新" class="mgr mgr-primary  mgr-lg attr_value"><span>成色新</span>
            </label>
            <label class="i-lab">
                <input type="checkbox" name="evaluate[5]" value="很划算" class="mgr mgr-primary  mgr-lg attr_value"><span>很划算</span>
            </label>
        </div>
    </div>
    <!-- <div class="form-group" style="margin-top: 20px;">
        <label for="evaluate" class="col-sm-2 control-label">好评标签</label>
        <div class="col-sm-4">
            <select   class="form-control"  name="evaluate" id="evaluate">
                    <option value="很靠谱">很靠谱</option>
                    <option value="物流快">物流快</option>
                    <option value="物美价廉">物美价廉</option>
                    <option value="服务好">服务好</option>
                    <option value="成色新">成色新</option>
                    <option value="很划算">很划算</option>
            </select>
        </div>
    </div> -->
    <div class="form-group" style="margin-top: 20px;">
        <label for="sort" class="col-sm-2 control-label">卖场</label>
        <div class="col-sm-10">
            {volist name="stores" id="v"}
            <label class="i-lab">
                <input type="radio" name="store_id" value='{$v.id}' class="mgr mgr-primary  mgr-lg"><span>{$v.store_name}</span>
            </label>
            {/volist}
        </div>
    </div>
    <div class="form-group" style="margin-top: 20px;">
        <label for="goods_unit" class="col-sm-2 control-label">商品封面</label>
        <div class="img_cont">
            <div class="img_prev"></div>
            <input type="file" name="goods_thums" id="goods_thums"  value=""/>
        </div>
    </div>
    <div class="form-group" style="margin-top: 20px;">
        <label for="goods_unit" class="col-sm-2 control-label">商品图片</label>
        <div class="img_cont">
            <div class="img_prev"></div>
            <input type="file" name="goods_img" id="goods_img"  value=""/>
        </div>
    </div>
    <div class="form-group" style="margin-top: 20px;">
        <label for="inventory" class="col-sm-2 control-label">商品库存</label>
        <div class="col-sm-4">
            <input type="text" name="inventory" class="form-control" id="inventory" placeholder="商品库存">
        </div>
    </div>
    <div class="form-group" style="margin-top: 20px;">
        <label for="giveaway" class="col-sm-2 control-label">赠品</label>
        <div class="col-sm-8">
            <input type="text" name="giveaway" class="form-control" id="giveaway" placeholder="赠品">
        </div>
    </div>
    <div class="form-group" style="margin-top: 20px;">
        <label for="sort" class="col-sm-2 control-label">是否上架</label>
        <div class="col-sm-4">
            <label class="i-lab">
                <input type="radio" name="is_sale" value='1' class="mgr mgr-primary  mgr-lg" checked><span>上架</span>
            </label>
            <label class="i-lab">
                <input type="radio" name="is_sale" value='0' class="mgr mgr-primary mgr-lg" ><span>下架</span>
            </label>
        </div>
    </div>
    
    

    <div class="panel" style="border-bottom: 1px solid #e7eaec;border-top:1px solid #e7eaec; ">
        <p style="margin:5px;font-size: 14px;color: #1ab394;font-weight:bold">商品属性</p>
    </div>
    {volist name="attrs" id="vo"}
    <div class="form-group attr" style="border-bottom: 1px solid #e7eaec;margin:5px; ">
        <label for="sort" class="col-sm-2 control-label ">{$vo.attr_name}</label>
        <input type="hidden" name="attr_id" value="{$vo.attr_id}" class="attr_id">
        <div class="col-sm-10">
            {volist name="$vo.value" id="v1" key="k"}
            <label class="i-lab">
                <input type="checkbox" name="attrs[{$vo.attr_id}][{$k}]" value="{$v1.value}" class="mgr mgr-primary  mgr-lg attr_value" {if condition="$k eq 1"}checked{/if} js-attrid ="{$vo.attr_id}"><span>{$v1.value}</span>
            </label>
            {/volist}

        </div>
    </div>
    {/volist}
    <button type="button" class="btn btn-primary " style="margin-left:450px;" id="submit-attr">确认属性</button>   
</div>
<div class="table-responsive">
    <table class="table table-hover table-bordered table-condensed">
        <thead>
            <tr>
                {volist name="attrs" id="vo"}
                <th>{$vo.attr_name}</th>
                {/volist}
                <th>赠送积分</th>
                <th>活动价格</th>
                <th>默认价格</th>
            </tr>
        </thead>
        <tbody id="goods_price_input">
          
        </tbody>
    </table>
</div>
<div class="form-group" style="margin-top: 20px;">
        <label for="inputPassword3" class="col-sm-2 control-label"></label>
        <div class="col-sm-4">
            <button type="submit" class="btn btn-primary js-submit-btn mr_3px button-submit" disabled="disabled">确认</button>&nbsp;&nbsp;&nbsp;
            <button type="reset" class="btn btn-primary">重置</button>
        </div>
    </div>
</form>
<script type="text/javascript">
function get_cate(data,type){
    cate_id= data.value;
    // console.log(cate_id)
    $.ajax({
        url:"{:url('good/ajax_get_cate')}",
        data:{cate_id:cate_id},
        type:"post",
        dataType:"json",
        success:function(msg){
            console.log(msg)
            var html       = "",
                html_brand = "",
                cates      = msg.cates,
                brands     = msg.brands;
            html        += "<option value='-1' >--请选择--</option>"
            html_brand  += "<option value='' >--请选择--</option>"
            if(type == 'cate1'){
                $('#cate_id2').empty();
                $('#cate_id3').empty();
                for(var i=0;i<cates.length;i++){
                    html += "<option value='"+cates[i].cate_id+"'}selected{/if}>"+cates[i].name+"</option>";
                }
                $(html).appendTo($("#cate_id2"));
            }else if(type == 'cate2'){
                $('#cate_id3').empty();
                for(var i=0;i<cates.length;i++){
                    html += "<option value='"+cates[i].cate_id+"'>"+cates[i].name+"</option>";
                }
                $(html).appendTo($("#cate_id3"));
            }
            $('#brand_id').empty();
            for(var i=0;i<brands.length;i++){
                html_brand += "<option value='"+brands[i].brand_id+"'>"+brands[i].brand_name+"</option>";
            }
            $(html_brand).appendTo($("#brand_id"));
        }
    })
}

$('#goods_thums').imgUpload({
    // width:150,//预览宽度
    // height:150,//预览高度
    maxSize: 500,//允许上传最大值(KB)
    imgWidth:220,//图片上传宽度
    imgHeight:220,//图片上传高度
    allowedNum:1,//允许上传最大数量
    files:{
        1:'{getImg}',
    }
})
$('#goods_img').imgUpload({
    // width:150,//预览宽度
    // height:150,//预览高度
    allowedNum:5,//允许上传最大数量
    maxSize: 500,//允许上传最大值(KB)
    files:{
        7:'{getImg}',
    }
})
function get_model(data){
    var brand_id = data.value;
    console.log(brand_id);
    $.ajax({
        url:"{:url('good/get_model')}",
        data:{brand_id:brand_id},
        dataType:"json",
        type:"post",
        success:function(msg){
            console.log(msg);
            var html = '';
            $('#model_list').empty();
            if(msg.length >0){
                for (var i = msg.length - 1; i >= 0; i--) {
                    html += '<label class="i-lab"><input type="radio" name="model_id" value="'+msg[i].model_id+'" class="mgr mgr-primary  mgr-lg"><span>'+msg[i].name+'</span></label>';
                }
            }else{
                 html += '<label class="i-lab">该品牌未添加型号</label>';
            }
            $(html).appendTo($("#model_list"));
        },
        error:function(msg){
            alert('no')
        }
    })
}
function doExchange(arr){
        var len = arr.length;
        // 当数组大于等于2个的时候
        if(len >= 2){
            // 第一个数组的长度
            var len1 = arr[0].length;
            // 第二个数组的长度
            var len2 = arr[1].length;
            // 2个数组产生的组合数
            var lenBoth = len1 * len2;
            //  申明一个新数组
            var items = new Array(lenBoth);
            // 申明新数组的索引
            var index = 0;
            for(var i=0; i<len1; i++){
                for(var j=0; j<len2; j++){
                    if(arr[0][i] instanceof Array){
                        items[index] = arr[0][i].concat(arr[1][j]);
                    }else{
                        items[index] = [arr[0][i]].concat(arr[1][j]);
                    }
                    index++;
                }
            }
            var newArr = new Array(len -1);
            for(var i=2;i<arr.length;i++){
                newArr[i-1] = arr[i];
            }
            newArr[0] = items;
            return doExchange(newArr);
        }else{
            return arr[0];
        }
    }
$("#submit-attr").click(function(){
    var aa = $('input[type="checkbox"');
    var all_attr = $('.attr');
    var all_attr_list   = [];
    var all_attr_id     = [];
    var i = 0;
    $.each(all_attr,function(k,v){
        var attr_id = $(v).find('.attr_id').val();
        var attrs   = $(v).find('.attr_value');
        var attr_value = [];
        var attr_value_id    = [];
        for(key in attrs){
            if(attrs[key].checked){
                attr_value.push(attrs[key].value);
                attr_value_id.push($(attrs[key]).attr('js-attrid'));
            }
        }
        all_attr_list[i] = attr_value;
        all_attr_id[i]   = attr_value_id;
        i = i+1;
        // console.log(attr_value)
    })
    // console.log(all_attr_list)
    // console.log(all_attr_id)
    
    var new_data = doExchange(all_attr_list);
    var new_attrids = doExchange(all_attr_id);
    console.log(new_attrids);
    var html = '';
    $('#goods_price_input').empty();
    for (var i = 0; i < new_data.length; i++) {
        html += '<tr>';
        for (var j = 0; j < new_data[i].length; j++) {
            html += '<td>'+new_data[i][j]+'<input type="hidden" name="price_id_value['+i+']['+j+']" class="form-control" value="'+new_data[i][j]+'"><input type="hidden" name="price_id['+i+']['+j+']" class="form-control" value="'+new_attrids[i][j]+'"></td>';
        }
        html += '<td  width="100px"><input type="text" name="integral['+i+']" class="form-control"></td><td  width="100px"><input type="text" name="campaign_price['+i+']" class="form-control"></td><td  width="100px"><input type="text" name="price['+i+']" class="form-control"></td>'
        html += '</tr>'
    }
    $('#goods_price_input').append(html);
    $('.button-submit').removeAttr("disabled");
})
</script>